rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper function to check if the requesting user has an 'admin' role.
     * It reads the 'role' field from the user's own profile document.
     */
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Rule: Users can only read and write their own profile document.
    // New users can create their profile upon signup.
    match /users/{userId} {
      allow read, update, delete: if request.auth.uid == userId;
      allow create: if request.auth != null;

      // Rule: Users can manage their own sub-collections (clients and posts).
      match /clients/{clientId} {
        allow read, write: if request.auth.uid == userId;
      }

      match /posts/{postId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // Rule: Only admins can read or write to the free_access collection.
    match /free_access/{grantId} {
      allow read, write: if isAdmin();
    }
  }
}